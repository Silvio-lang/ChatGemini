<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Simulador - Pista de Atletismo</title>
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
    }
    
    body { 
        background:#1a1a2e; 
        color:#eee; 
        font-family: 'Segoe UI', Arial, sans-serif; 
        overflow: hidden;
        touch-action: none;
        width: 100vw;
        height: 100vh;
    }
    
    #info {
        text-align:center;
        padding:6px 4px;
        background:#16213e;
        font-size:11px;
        border-bottom: 1px solid #0f3460;
        display: flex;
        justify-content: center;
        gap: 8px;
        flex-wrap: wrap;
        width: 100%;
    }
    
    .stat { 
        background: #0f3460; 
        padding: 3px 8px; 
        border-radius: 3px; 
        font-family: monospace;
        font-size: 10px;
        white-space: nowrap;
    }
    
    .alert { color: #ff6b6b; font-weight: bold; }
    .ok { color: #51cf66; }
    
    canvas { 
        background: #2a2a3a; 
        display:block; 
        width: 100%;
        height: calc(100vh - 45px);
    }
</style>
</head>
<body>

<div id="info">
    <span class="stat">Dist: <b id="distVal">0.00</b>m</span>
    <span class="stat">Alvo: <b id="targetVal">--</b></span>
    <span class="stat" id="stateStat">Estado: <b id="stateVal">Neutro</b></span>
    <span class="stat">ðŸ”´E:<b id="leftVal">OFF</b></span>
    <span class="stat">ðŸ”´D:<b id="rightVal">OFF</b></span>
</div>

<canvas id="canvas"></canvas>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  âš™ï¸  CONFIGURAÃ‡Ã•ES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const CONFIG = {
    driftSpeed: 0.10,                     // Velocidade da fuga de rota
    correctionSpeed: 0.25,         // Velocidade da correÃ§Ã£o
    reactionDelay: 450,             // Tempo de reaÃ§Ã£o ao vibracall
    stabilizationDelay: 450,    // Tempo reaÃ§Ã£o saÃ­da do vibracall
    scrollSpeed: 1.0,                   // Velocidade da pista
    stepInterval: 800,               // Intervalo dos passos
    stepLiftHeight: 12,                 //  Levantamento dos pÃ©s
    laneWidth: 160,                   // Largura de cada pista
    distractionPause: 6000,   // Tempo entre distraÃ§Ãµes do atleta
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

// â­ CANVAS RESPONSIVO - Ajusta ao tamanho da tela
function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight - 45; // Subtrai altura do info bar
}
resizeCanvas();
window.addEventListener('resize', resizeCanvas);

const ui = {
    dist: document.getElementById("distVal"),
    target: document.getElementById("targetVal"),
    state: document.getElementById("stateVal"),
    left: document.getElementById("leftVal"),
    right: document.getElementById("rightVal")
};

// =============================
// ESCALA E POSIÃ‡ÃƒO (DINÃ‚MICA)
// =============================
let pixelsPerMeter = 150; // SerÃ¡ ajustado dinamicamente
let blueLineX;

function updateScale() {
    blueLineX = canvas.width / 2;
    // Ajusta escala baseada na largura da tela
    pixelsPerMeter = Math.min(150, canvas.width / 4);
}
updateScale();
window.addEventListener('resize', updateScale);

// =============================
// PERSONAGEM (PROPORÃ‡Ã•ES AJUSTADAS)
// =============================
let person = {
    x: 0, // SerÃ¡ definido no init
    y: 0,
    headRadius: 12,
    torsoHeight: 23,
    legLength: 28,
    armLength: 24
};

function initPerson() {
    person.x = blueLineX + (1.0 * pixelsPerMeter);
    person.y = canvas.height * 0.55;
}
initPerson();
window.addEventListener('resize', initPerson);

// =============================
// ANIMAÃ‡ÃƒO
// =============================
let stepPhase = 0;
let stepProgress = 0;
let lastStepTime = 0;
let scrollOffset = 0;

// =============================
// DISTRAÃ‡ÃƒO (DRIFT)
// =============================
let driftDirection = 0;
let distractionActive = false;
let lastAlertTime = 0;

// =============================
// CORREÃ‡ÃƒO - ESTADOS
// =============================
let alarmOnTime = null;
let correctionStartTime = null;
let reachedTargetTime = null;
let correctionTargetMeters = null;
let correctionDirection = 0;

// =============================
// ESTADO - ALARMES VISUAIS
// =============================
let leftSignal = false;
let rightSignal = false;

const LIMITS = {
    far: { trigger: 1.20, release: 1.05, target: 1.05, signal: 'right' },
    near: { trigger: 0.80, release: 0.95, target: 0.95, signal: 'left' }
};

// =============================
// LÃ“GICA - DRIFT
// =============================

function tryStartDistraction(timestamp) {
    if(!correctionStartTime && !distractionActive && 
       (timestamp - lastAlertTime > CONFIG.distractionPause)) {
        driftDirection = Math.random() > 0.5 ? 1 : -1;
        distractionActive = true;
    }
}

function updateDrift() {
    if(distractionActive) {
        person.x += driftDirection * CONFIG.driftSpeed;
    }
}

// =============================
// LÃ“GICA - ALARMES VISUAIS
// =============================

function updateAlarms() {
    const distanceMeters = (person.x - blueLineX) / pixelsPerMeter;

    if(!rightSignal && distanceMeters >= LIMITS.far.trigger) {
        rightSignal = true;
        leftSignal = false;
        alarmOnTime = performance.now();
        correctionStartTime = null;
        reachedTargetTime = null;
        correctionTargetMeters = LIMITS.far.target;
        lastAlertTime = performance.now();
    }
    if(rightSignal && distanceMeters <= LIMITS.far.release) {
        rightSignal = false;
    }

    if(!leftSignal && distanceMeters <= LIMITS.near.trigger) {
        leftSignal = true;
        rightSignal = false;
        alarmOnTime = performance.now();
        correctionStartTime = null;
        reachedTargetTime = null;
        correctionTargetMeters = LIMITS.near.target;
        lastAlertTime = performance.now();
    }
    if(leftSignal && distanceMeters >= LIMITS.near.release) {
        leftSignal = false;
    }
}

// =============================
// LÃ“GICA - CORREÃ‡ÃƒO COM INÃ‰RCIA
// =============================

function updateCorrection(timestamp) {
    if(alarmOnTime !== null && !correctionStartTime) {
        if(timestamp - alarmOnTime >= CONFIG.reactionDelay) {
            distractionActive = false;
            driftDirection = 0;
            correctionStartTime = timestamp;
            
            const targetX = blueLineX + (correctionTargetMeters * pixelsPerMeter);
            correctionDirection = Math.sign(targetX - person.x);
        }
        return;
    }
    
    if(correctionStartTime !== null) {
        const targetX = blueLineX + (correctionTargetMeters * pixelsPerMeter);
        const distance = targetX - person.x;
        
        if(reachedTargetTime === null && Math.abs(distance) <= CONFIG.correctionSpeed) {
            reachedTargetTime = timestamp;
        }
        
        if(reachedTargetTime !== null) {
            const stabilizationElapsed = timestamp - reachedTargetTime;
            
            if(stabilizationElapsed < CONFIG.stabilizationDelay) {
                person.x += correctionDirection * (CONFIG.correctionSpeed * 0.75);
            } else {
                correctionStartTime = null;
                reachedTargetTime = null;
                alarmOnTime = null;
                correctionTargetMeters = null;
                correctionDirection = 0;
            }
        } else {
            if(Math.abs(distance) > 0.01) {
                person.x += Math.sign(distance) * CONFIG.correctionSpeed;
            }
        }
        return;
    }
}

// =============================
// CAMINHADA
// =============================

function updateWalk(timestamp) {
    if(timestamp - lastStepTime > CONFIG.stepInterval) {
        stepPhase = 1 - stepPhase;
        lastStepTime = timestamp;
        stepProgress = 0;
    } else {
        const elapsed = timestamp - lastStepTime;
        stepProgress = Math.min(1, elapsed / CONFIG.stepInterval);
    }
    
    scrollOffset = (scrollOffset + CONFIG.scrollSpeed) % 40;
}

function getDistanceMeters() {
    return (person.x - blueLineX) / pixelsPerMeter;
}

function updateInfo() {
    const dist = getDistanceMeters();
    ui.dist.textContent = dist.toFixed(2);
    ui.target.textContent = correctionTargetMeters !== null ? correctionTargetMeters.toFixed(2) : '--';
    
    ui.left.textContent = leftSignal ? 'ON' : 'OFF';
    ui.right.textContent = rightSignal ? 'ON' : 'OFF';
    
    if(alarmOnTime !== null && !correctionStartTime) {
        const remaining = CONFIG.reactionDelay - (performance.now() - alarmOnTime);
        ui.state.textContent = `Reag...${Math.max(0, remaining/1000).toFixed(1)}s`;
        ui.state.className = 'alert';
    } else if(reachedTargetTime !== null) {
        const remaining = CONFIG.stabilizationDelay - (performance.now() - reachedTargetTime);
        ui.state.textContent = `Estab...${Math.max(0, remaining/1000).toFixed(1)}s`;
        ui.state.className = 'alert';
    } else if(correctionStartTime !== null) {
        ui.state.textContent = 'Corrigindo';
        ui.state.className = 'alert';
    } else if(distractionActive) {
        ui.state.textContent = 'Drift';
        ui.state.className = '';
    } else {
        ui.state.textContent = 'Neutro';
        ui.state.className = 'ok';
    }
    
    ui.left.style.color = leftSignal ? '#ff6b6b' : '#888';
    ui.right.style.color = rightSignal ? '#ff6b6b' : '#888';
}

// =============================
// DESENHO - PISTA
// =============================

function drawTrack() {
    ctx.fillStyle = '#b85450';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    ctx.fillStyle = 'rgba(0,0,0,0.05)';
    for(let i = 0; i < 200; i++) {
        const x = (i * 137.5) % canvas.width;
        const y = (i * 89.3) % canvas.height;
        ctx.fillRect(x, y, 2, 2);
    }
    
    const laneWidth = CONFIG.laneWidth;
    const laneOffset = blueLineX - (laneWidth / 2);
    
    ctx.strokeStyle = 'rgba(255,255,255,0.7)';
    ctx.lineWidth = 2;
    
    const numLanes = Math.ceil(canvas.width / laneWidth) + 2;
    
    for(let i = -1; i < numLanes; i++) {
        const x = laneOffset + (i * laneWidth);
        
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, canvas.height);
        ctx.stroke();
        
        const labelY = ((scrollOffset + i * 150) % 500) + 80;
        if(labelY > 40 && labelY < canvas.height - 40) {
            ctx.fillStyle = 'rgba(255,255,255,0.5)';
            ctx.font = 'bold 12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(`R${i+2}`, x, labelY);
        }
    }
    
    ctx.strokeStyle = 'rgba(255,255,255,0.3)';
    ctx.lineWidth = 1;
    ctx.setLineDash([25, 20]);
    ctx.lineDashOffset = -scrollOffset;
    
    for(let y = -50; y < canvas.height; y += 120) {
        const yPos = y + scrollOffset;
        if(yPos > 0 && yPos < canvas.height) {
            ctx.beginPath();
            ctx.moveTo(0, yPos);
            ctx.lineTo(canvas.width, yPos);
            ctx.stroke();
        }
    }
    ctx.setLineDash([]);
}

function drawBlueLine() {
    ctx.strokeStyle = '#4dabf7';
    ctx.lineWidth = 4;
    ctx.shadowColor = '#4dabf7';
    ctx.shadowBlur = 8;
    
    ctx.beginPath();
    ctx.moveTo(blueLineX, 0);
    ctx.lineTo(blueLineX, canvas.height);
    ctx.stroke();
    ctx.shadowBlur = 0;
    
    // === CABO (REF) - MantÃ©m posiÃ§Ã£o ===
    ctx.fillStyle = '#FFFFFF';
    ctx.font = 'bold 16px monospace';
    ctx.textAlign = 'center';
    
    ctx.shadowColor = 'rgba(0,0,0,0.8)';
    ctx.shadowBlur = 4;
    ctx.shadowOffsetX = 1;
    ctx.shadowOffsetY = 1;
    ctx.fillText('Cabo (REF)', blueLineX, 24);  // â† MantÃ©m aqui
    ctx.shadowBlur = 0;
    ctx.shadowOffsetX = 0;
    ctx.shadowOffsetY = 0;
    
    // === MARCADORES 0.80m e 1.20m - â­ MAIS BAIXOS (42 em vez de 24) ===
    ctx.fillStyle = '#FFFFFF';
    ctx.font = 'bold 15px monospace';
    ctx.textAlign = 'center';
    
    const mark80 = blueLineX + (0.80 * pixelsPerMeter);
    const mark120 = blueLineX + (1.20 * pixelsPerMeter);
    
    ctx.shadowColor = 'rgba(0,0,0,0.8)';
    ctx.shadowBlur = 4;
    ctx.shadowOffsetX = 1;
    ctx.shadowOffsetY = 1;
    
    ctx.fillText('0.80m', mark80, 42);   // â­ MUDEI DE 24 PARA 42
    ctx.fillText('1.20m', mark120, 42);  // â­ MUDEI DE 24 PARA 42
    
    ctx.shadowBlur = 0;
    ctx.shadowOffsetX = 0;
    ctx.shadowOffsetY = 0;
    
    // === LINHAS TRACEJADAS ===
    ctx.strokeStyle = 'rgba(255,255,255,0.6)';
    ctx.lineWidth = 2;
    ctx.setLineDash([6, 6]);
    
    ctx.beginPath();
    ctx.moveTo(mark80, 0);
    ctx.lineTo(mark80, canvas.height);
    ctx.stroke();
    
    ctx.beginPath();
    ctx.moveTo(mark120, 0);
    ctx.lineTo(mark120, canvas.height);
    ctx.stroke();
    
    ctx.setLineDash([]);
}

function drawTargetGuide() {
    if(correctionTargetMeters !== null) {
        const targetX = blueLineX + (correctionTargetMeters * pixelsPerMeter);
        ctx.strokeStyle = 'rgba(81, 207, 102, 0.9)';
        ctx.lineWidth = 3;
        ctx.setLineDash([8, 6]);
        ctx.shadowColor = '#51cf66';
        ctx.shadowBlur = 10;
        
        ctx.beginPath();
        ctx.moveTo(targetX, 0);
        ctx.lineTo(targetX, canvas.height);
        ctx.stroke();
        ctx.shadowBlur = 0;
        ctx.setLineDash([]);
        
        ctx.fillStyle = '#51cf66';
        ctx.font = 'bold 10px monospace';
        ctx.textAlign = 'center';
        ctx.fillText(`ALVO: ${correctionTargetMeters.toFixed(2)}m`, targetX, canvas.height - 10);
    }
}

function drawPerson() {
    const x = person.x;
    const baseY = person.y;
    
    ctx.fillStyle = 'rgba(0,0,0,0.4)';
    ctx.beginPath();
    ctx.ellipse(x, baseY + person.torsoHeight + person.legLength + 8, 18, 6, 0, 0, Math.PI * 2);
    ctx.fill();
    
    ctx.strokeStyle = '#4a4a4a';
    ctx.lineWidth = 4;
    ctx.lineCap = 'round';
    
    const liftFactor = Math.sin(stepProgress * Math.PI);
    const currentLift = liftFactor * CONFIG.stepLiftHeight;
    
    const frontFootX = x + (stepPhase ? 8 : -8);
    const frontFootY = baseY + person.torsoHeight + person.legLength - currentLift;
    const backFootX = x + (stepPhase ? -8 : 8);
    const backFootY = baseY + person.torsoHeight + person.legLength;
    
    ctx.beginPath();
    ctx.moveTo(x, baseY + person.torsoHeight - 8);
    ctx.lineTo(frontFootX, frontFootY - 8);
    ctx.lineTo(frontFootX, frontFootY);
    ctx.stroke();
    
    ctx.beginPath();
    ctx.moveTo(x, baseY + person.torsoHeight - 8);
    ctx.lineTo(backFootX, backFootY);
    ctx.stroke();
    
    ctx.fillStyle = '#2a2a2a';
    ctx.beginPath();
    ctx.ellipse(frontFootX, frontFootY, 7, 4, 0, 0, Math.PI * 2);
    ctx.fill();
    ctx.beginPath();
    ctx.ellipse(backFootX, backFootY, 8, 5, 0, 0, Math.PI * 2);
    ctx.fill();
    
    ctx.strokeStyle = '#666';
    ctx.lineWidth = 4;
    ctx.beginPath();
    ctx.moveTo(x, baseY - 20);
    ctx.lineTo(x, baseY + person.torsoHeight - 10);
    ctx.stroke();
    
    const armSwing = Math.sin(stepProgress * Math.PI * 2) * 6;
    ctx.lineWidth = 3;
    
    ctx.beginPath();
    ctx.moveTo(x, baseY - 13);
    ctx.lineTo(x - 15 + armSwing * 0.5, baseY + 3);
    ctx.stroke();
    
    ctx.beginPath();
    ctx.moveTo(x, baseY - 13);
    ctx.lineTo(x + 15 - armSwing * 0.5, baseY + 3);
    ctx.stroke();
    
    const headGradient = ctx.createRadialGradient(x - 3, baseY - 35, 3, x, baseY - 30, person.headRadius);
    headGradient.addColorStop(0, '#f0d0b0');
    headGradient.addColorStop(1, '#d4a58a');
    ctx.fillStyle = headGradient;
    ctx.beginPath();
    ctx.arc(x, baseY - 30, person.headRadius, 0, Math.PI * 2);
    ctx.fill();
    
    ctx.fillStyle = '#333';
    ctx.beginPath();
    ctx.arc(x - 3, baseY - 32, 2, 0, Math.PI * 2);
    ctx.arc(x + 3, baseY - 32, 2, 0, Math.PI * 2);
    ctx.fill();
    
    const shoulderY = baseY - 8;
    
    ctx.fillStyle = leftSignal ? '#ff6b6b' : '#666';
    ctx.shadowColor = leftSignal ? '#ff6b6b' : 'transparent';
    ctx.shadowBlur = leftSignal ? 15 : 0;
    ctx.beginPath();
    ctx.arc(x - 20, shoulderY, 9, 0, Math.PI * 2);
    ctx.fill();
    ctx.shadowBlur = 0;
    
    ctx.fillStyle = rightSignal ? '#ff6b6b' : '#666';
    ctx.shadowColor = rightSignal ? '#ff6b6b' : 'transparent';
    ctx.shadowBlur = rightSignal ? 15 : 0;
    ctx.beginPath();
    ctx.arc(x + 20, shoulderY, 9, 0, Math.PI * 2);
    ctx.fill();
    ctx.shadowBlur = 0;
    
    ctx.fillStyle = '#fff';
    ctx.font = 'bold 8px monospace';
    ctx.textAlign = 'center';
    ctx.fillText('E', x - 20, shoulderY + 3);
    ctx.fillText('D', x + 20, shoulderY + 3);
}

function drawZones() {
    const safeMin = blueLineX + (0.95 * pixelsPerMeter);
    const safeMax = blueLineX + (1.05 * pixelsPerMeter);
    ctx.fillStyle = 'rgba(81, 207, 102, 0.20)';  // â­ Um pouco mais opaco
    ctx.fillRect(safeMin, 0, safeMax - safeMin, canvas.height);
    
    const alertFar = blueLineX + (1.20 * pixelsPerMeter);
    ctx.fillStyle = 'rgba(255, 107, 107, 0.15)';  // â­ Mais visÃ­vel
    ctx.fillRect(alertFar, 0, canvas.width - alertFar, canvas.height);
    
    const alertNear = blueLineX + (0.80 * pixelsPerMeter);
    ctx.fillStyle = 'rgba(255, 180, 80, 0.15)';  // â­ Mais visÃ­vel
    ctx.fillRect(0, 0, alertNear - blueLineX, canvas.height);
    
    // === ZONA SEGURA - BRANCO, 50% maior, negrito ===
    ctx.fillStyle = '#FFFFFF';  // â­ BRANCO PURO
    ctx.font = 'bold 14px monospace';  // â­ 50% maior (era 9px)
    ctx.textAlign = 'center';
    
    // Sombra para contraste
    ctx.shadowColor = 'rgba(0,0,0,0.9)';
    ctx.shadowBlur = 6;
    ctx.shadowOffsetX = 1;
    ctx.shadowOffsetY = 1;
    
    ctx.fillText('ZONA SEGURA', (safeMin + safeMax)/2, 18);
    
    ctx.shadowBlur = 0;
    ctx.shadowOffsetX = 0;
    ctx.shadowOffsetY = 0;
}

// =============================
// LOOP PRINCIPAL
// =============================

function draw(timestamp) {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    tryStartDistraction(timestamp);
    updateDrift();
    updateAlarms();
    updateCorrection(timestamp);
    updateWalk(timestamp);
    updateInfo();
    
    drawTrack();
    drawZones();
    drawBlueLine();
    drawTargetGuide();
    drawPerson();
    
    requestAnimationFrame(draw);
}

requestAnimationFrame(draw);
</script>

</body>
</html>